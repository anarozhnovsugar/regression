#!/usr/bin/env php
<?php
error_reporting(E_ALL & ~E_DEPRECATED);
require dirname(__DIR__) . '/vendor/autoload.php';

use GuzzleHttp\Psr7\Message;
use Psr\Http\Message\RequestInterface;
use Psr\Http\Message\ResponseInterface;
use Regression\Config;
use Regression\Status;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\SingleCommandApplication;
use Symfony\Component\Console\Style\SymfonyStyle;

(new SingleCommandApplication())
    ->setName('Regression Testing') // Optional
    ->setVersion('0.2') // Optional
    ->addArgument('base_uri', InputArgument::REQUIRED, 'The base uri of your application')
    ->addOption('tests_dir', 'd', InputOption::VALUE_OPTIONAL, 'The directory where your tests are placed', './tests')
    ->addOption('type', 't', InputOption::VALUE_OPTIONAL, 'Type of the test: "assessment" or "regression". Default - both')
    ->addOption('test_files', 'f', InputOption::VALUE_OPTIONAL|InputOption::VALUE_IS_ARRAY, 'Path to the file with the test (separate multiple paths with a space)')
    ->addOption('debug', null, InputOption::VALUE_NONE, 'Show detailed info about requests and responses')
    ->addOption('trace', null, InputOption::VALUE_NONE, 'Add X-Test-Name Header with the Scenario class name as a value for each request')
    ->addOption('credentials', 'c', InputOption::VALUE_OPTIONAL|InputOption::VALUE_IS_ARRAY, 'Credentials. Colon-separated username+password')
    ->setCode(function (InputInterface $input, OutputInterface $output) {

        $type = $input->getOption('type');
        $testFiles = $input->getOption('test_files');
        if (!empty($testFiles)) {
            $iterator = $testFiles;
        } else {
            if ($type !== null && !in_array(strtolower($type), ['regression', 'assessment'])) {
                throw new InvalidArgumentException("'type' can be only 'regression' or 'assessment', '{$type}' given");
            } else {
                $rx = $type === null ? '/^.+(Regression|Assessment)\.php$/' : "/^.+{$type}\.php$/i";
            }
            $customRecursiveIterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($input->getOption('tests_dir')));
            $iterator = new RegexIterator($customRecursiveIterator, $rx);
        }
        $io = new SymfonyStyle($input, $output);
        $io->title('Running Regression Tests...');

        $testsCount = 0;
        $failed = 0;
        $success = 0;
        $regressions = [];
        $vulnerabilities = [];
        $io->progressStart(iterator_count($iterator));
        foreach ($iterator as $classFile) {
            if (!file_exists($classFile)) {
                $io->error("$classFile doesn't exist. Skipped");
                continue;
            }
            require_once $classFile;
            $class = basename($classFile, '.php');
            $configParams = ['baseUri' => $input->getArgument('base_uri')];
            if ($credentials = $input->getOption('credentials')) {
                $loginPasswordPairs = [];
                foreach ($credentials as $credential) {
                    [$login, $password] = explode(':', $credential, 2);
                    $loginPasswordPairs[$login] = $password;
                }
                $configParams['credentials'] = $loginPasswordPairs;
            }
            $config = Config::create($configParams);
            /**
             * @var \Regression\Scenario $scenario
             */
            $scenario = new $class($config);
            if ($input->getOption('trace')) {
                $scenario->onRequest(function (RequestInterface &$request) use ($scenario) {
                    $request = $request->withHeader('X-Test-Name', get_class($scenario));
                });
            }

            if ($input->getOption('debug')) {
                $scenario->onRequest(function (RequestInterface $request, array $options = []) use ($io) {
                    $io->newLine(2);
                    $io->title('Request to ' . $request->getUri());
                    $io->section(
                        Message::toString($request)
                    );
                    if (count($options)) {
                        $io->section(var_export($options, true));
                    }
                })->onResponse(function (ResponseInterface $response) use ($io) {
                        $io->title('Response');
                        $io->section(
                            Message::toString($response)
                        );
                    });
            }
            $testsCount++;
            try {
                $scenario->run();
                if ($scenario->getStatus() === Status::UNKNOWN) {
                    $io->error("Risky. No expectations or assumptions made: {$scenario->getDescription()}");
                } elseif ($scenario->getStatus() === Status::HAS_ISSUE) {
                    $vulnerabilities[] = $scenario->getSeverity()?
                        sprintf('[%s] %s: "%s"', $scenario->getSeverity(), $scenario->getDescription(), $scenario->getConclusion()):
                        sprintf('%s: "%s"', $scenario->getDescription(), $scenario->getConclusion());
                    $failed++;
                } else {
                    $success++;
                }
            } catch (Throwable $exception) {
                $regressions[] = $scenario->getSeverity()?
                    sprintf('[%s] %s: "%s"', $scenario->getSeverity(), $scenario->getDescription(), $exception->getMessage()):
                    sprintf('%s: "%s"', $scenario->getDescription(), $exception->getMessage());
                $failed++;
            } finally {
                $io->progressAdvance();
            }
        }

        $io->progressFinish();
        $io->horizontalTable(['Total', 'Success', 'Issues'], [
            [$testsCount, $success, $failed]
        ]);
        if ($failed === 0) {
            $io->success('No issues found');
            return 0;
        }

        if (count($regressions)) {
            $io->error('Regression!');
            $io->listing($regressions);
        }
        if (count($vulnerabilities)) {
            $io->error('Possible vulnerabilities');
            $io->listing($vulnerabilities);
        }
        return 1;
    })
    ->run();